<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Replica — Single File</title>
  <!-- Local-only config loader. Create 'config.local.js' alongside this file with SUPABASE_URL and SUPABASE_ANON_KEY. This file is git-ignored. -->
  <script src="config.local.js"></script>
  <style>
    :root {
      --bg: #0f1115;
      --panel: #141821;
      --panel-2: #0d1016;
      --muted: #8b93a7;
      --text: #e7eaf3;
      --accent: #4f6af2;
      --accent-2: #7a8cff;
      --border: #1f2430;
      --green: #1ec28b;
      --yellow: #f2c84b;
      --red: #ef5b5b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 14px;
    }
    [data-theme="light"]{
      --bg:#f6f7fb; --panel:#ffffff; --panel-2:#f2f4f8; --muted:#657089; --text:#141821; --border:#e7eaf3; --shadow:0 8px 24px rgba(16,24,40,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text); font:14px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    .app{display:grid; grid-template-columns: 260px 1fr 360px; gap:18px; height:100vh; padding:18px}
    .app.chat-closed{grid-template-columns: 260px 1fr}
    .panel{background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow)}
    .sidebar{display:flex; flex-direction:column; padding:14px}
    .profile{display:flex; align-items:center; gap:10px; padding:8px; border-radius:10px}
    .avatar{width:34px; height:34px; background:linear-gradient(135deg,#5a83f2,#7b61ff); border-radius:50%; display:grid; place-items:center; font-weight:700}
    .brand{font-weight:700}
    .muted{color:var(--muted)}
    .button{display:inline-flex; align-items:center; gap:8px; border:1px solid var(--border); background:var(--panel-2); color:var(--text); padding:10px 12px; border-radius:10px; cursor:pointer}
    .button.ghost{background:transparent}
    .button.primary{background:var(--accent); border-color:transparent}
    .section{margin:10px 0 6px; font-size:12px; text-transform:uppercase; letter-spacing:.08em; color:var(--muted)}
    .nav-group{border:1px solid var(--border); border-radius:12px; overflow:hidden}
    .nav-header{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; background:var(--panel-2); cursor:pointer}
    .nav-items{display:grid}
    .nav-item{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; gap:10px; border-top:1px solid var(--border); cursor:pointer}
    .badge{font-size:12px; padding:2px 8px; background:var(--panel-2); border:1px solid var(--border); border-radius:999px}
    .promo{margin-top:12px; padding:12px; display:grid; gap:8px; background:linear-gradient(180deg, rgba(79,106,242,.08), transparent);}
    .meter{display:grid; gap:6px; margin-top:10px}
    .meter .row{display:flex; align-items:center; justify-content:space-between; font-size:12px}
    .bar{height:8px; background:var(--panel-2); border-radius:999px; overflow:hidden; border:1px solid var(--border)}
    .bar > span{display:block; height:100%; background:linear-gradient(90deg,var(--accent),var(--accent-2)); width:0}
    .bar[data-val="15"]>span{width:15%}
    .bar[data-val="30"]>span{width:30%}
    .bar[data-val="0"]>span{width:0%}
    .spacer{flex:1}

    /* MAIN */
    .main{display:grid; grid-template-rows:auto 1fr; padding:14px}
    .topbar{display:flex; align-items:center; gap:10px}
    .search{position:relative; flex:1}
    .search input{width:100%; padding:12px 40px; border-radius:999px; background:var(--panel-2); border:1px solid var(--border); color:var(--text)}
    .search svg{position:absolute; left:12px; top:50%; transform:translateY(-50%); width:18px; height:18px; opacity:.7}
    .go-btn{border-radius:999px; padding:10px; border:1px solid var(--border); background:var(--panel-2); cursor:pointer}
    .content{margin-top:14px; display:grid; grid-template-rows:auto 1fr}
    .content-head{display:flex; align-items:center; justify-content:space-between}
    .title{display:flex; align-items:baseline; gap:10px}
    .title h2{margin:0}
    .view-controls{display:flex; align-items:center; gap:8px}
    .segmented{display:flex; border:1px solid var(--border); border-radius:999px; overflow:hidden}
    .segmented button{padding:8px 12px; background:transparent; border:0; color:var(--text); cursor:pointer}
    .segmented button.active{background:var(--panel-2)}

    .card-grid{margin-top:12px; display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:14px; align-items:start}
    .lib-card{background:var(--panel-2); border:1px solid var(--border); border-radius:14px; padding:14px; display:grid; gap:16px; cursor:pointer; align-self:start}
    .lib-visual{height:80px; border:1px dashed var(--border); border-radius:12px; display:grid; place-items:center; color:var(--muted)}
    .lib-meta{display:flex; align-items:center; justify-content:space-between; color:var(--muted); font-size:12px}

    /* LIST VIEW */
    .list .card-grid{grid-template-columns:1fr}
    .list .lib-card{display:grid; grid-template-columns:80px 1fr auto; align-items:center}
    .list .lib-visual{height:60px}

    /* RIGHT / CHAT */
    .right{display:grid; grid-template-rows: 1fr auto; padding:14px; position:relative; z-index:20}
    .stage{display:block; color:var(--muted); border:1px dashed var(--border); border-radius:14px}
    .composer{margin-top:12px; padding:0; overflow:hidden}
    .composer-head{padding:12px 14px; border-bottom:1px solid var(--border); background:var(--panel-2); display:flex; align-items:center; justify-content:space-between}
    .composer-body{padding:12px; display:grid; gap:8px}
    .input{display:flex; align-items:center; gap:10px; border:1px solid var(--border); background:var(--panel); border-radius:12px; padding:8px}
    .input input{flex:1; background:transparent; border:0; color:var(--text); outline:none; padding:8px}
    .pill{font-size:12px; padding:6px 10px; background:var(--panel-2); border:1px solid var(--border); border-radius:999px; white-space:nowrap; flex-shrink:0; display:inline-flex; align-items:center; gap:6px; cursor:pointer}
    /* Chat layout improvements */
    #threadsList .thread-item{display:flex; align-items:center; justify-content:space-between; padding:10px; border:1px solid var(--border); background:var(--panel); border-radius:10px; cursor:pointer}
    #threadsList .thread-item.active{background:var(--panel-2); border-color:var(--accent)}
    #chatMessages{display:grid; align-content:start; gap:8px}
    .message{max-width:85%; padding:8px 10px; border-radius:10px; border:1px solid var(--border); word-wrap:break-word; white-space:pre-wrap}
    .message.user{justify-self:end; background:var(--accent); color:#fff; border-color:transparent}
    .message.assistant{justify-self:start; background:var(--panel-2)}
    .empty{color:var(--muted); text-align:center; padding:14px}

    /* Model dropdown */
    .input{position:relative}
    .menu{position:absolute; right:0; top:calc(100% + 8px); width:220px; background:var(--panel); border:1px solid var(--border); border-radius:10px; box-shadow:var(--shadow); display:none; overflow:hidden; z-index:20}
    .menu.open{display:grid}
    .menu button{background:transparent; border:0; padding:10px 12px; color:var(--text); text-align:left; cursor:pointer}
    .menu button:hover{background:var(--panel-2)}

    /* RAG debug panel */
    .rag-debug{margin-top:10px; padding:10px; background:var(--panel-2); border:1px dashed var(--border); border-radius:10px; color:var(--muted); font-size:12px; max-height:140px; overflow:auto; display:none}

    /* Floating chat tab & scrim */
    .chat-tab{display:none; position:fixed; right:6px; top:50%; transform:translateY(-50%); background:var(--panel); border:1px solid var(--border); border-right:0; color:var(--text); padding:10px 12px; border-radius:10px 0 0 10px; box-shadow:var(--shadow); align-items:center; gap:8px; cursor:pointer; z-index:30}
    .chat-tab .icon{opacity:.9}
    .app.chat-closed .chat-tab{display:flex}
    .app.chat-closed .right{display:none}
    .scrim{display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:10}
    /* Ensure scrim doesn't block the chat when open on desktop layout */
    @media (min-width: 1201px){
      .app.chat-open #chatPanel{z-index:40}
      .app.chat-open #scrim{z-index:30}
      /* Do not show scrim on desktop so main area remains interactive */
      .app.chat-open .scrim{display:none}
    }
    .app.chat-open .scrim{display:block}

    /* ICONS */
    .icon{width:18px; height:18px; display:inline-block; vertical-align:middle}

    /* Responsive */
    @media (max-width: 1200px){
      .app{grid-template-columns: 220px 1fr}
      /* Show chat as an overlay when opened on smaller screens */
      .app.chat-open .right{display:grid; position:fixed; right:18px; top:18px; bottom:18px; width:min(360px, calc(100vw - 60px)); z-index:40}
      .app.chat-open #scrim{display:block}
    }
    @media (max-width: 780px){
      .app{grid-template-columns:1fr}
      .sidebar{display:none}
    }
    a { color: inherit; text-decoration: none; }
    .kbd{font: 12px/1.2 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background: var(--panel-2); border:1px solid var(--border); padding:2px 6px; border-radius:6px}
  </style>
  <style>
    /* Simple modal */
    .modal-scrim{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.5); z-index:100}
    .modal{width:min(520px, 92vw); background:var(--panel); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); overflow:hidden}
    .modal-head{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; background:var(--panel-2); border-bottom:1px solid var(--border)}
    .modal-body{padding:14px; display:grid; gap:10px}
    .field{display:grid; gap:6px}
    .field label{font-size:12px; color:var(--muted)}
    .field input, .field textarea{background:transparent; border:1px solid var(--border); color:var(--text); padding:8px 10px; border-radius:8px}
    .modal-actions{display:flex; justify-content:flex-end; gap:8px; padding:12px 14px; border-top:1px solid var(--border)}
    .modal-show{display:flex}
    /* Toasts */
    .toasts{position:fixed; right:18px; bottom:18px; display:grid; gap:8px; z-index:200}
    .toast{background:var(--panel); border:1px solid var(--border); color:var(--text); padding:10px 12px; border-radius:10px; box-shadow:var(--shadow)}
  </style>
</head>
<body>
  <div class="app chat-open" id="appRoot">
    <!-- SIDEBAR -->
    <aside class="sidebar panel" aria-label="Sidebar">
      <div class="profile">
        <div class="avatar" aria-hidden="true">G</div>
        <div>
          <div class="brand">Giannandrea G.</div>
          <div class="muted" style="font-size:12px">Ask HIve</div>
        </div>
        <div class="spacer"></div>
        <button class="button ghost" title="Toggle theme" id="toggleTheme" aria-label="Toggle theme">
          <svg class="icon"><use href="#sun"></use></svg>
        </button>
      </div>

      <button class="button primary" id="askHiveBtn" style="margin-top:8px; width:100%">
        <svg class="icon"><use href="#spark"></use></svg>
        Ask HIve
      </button>

      <div class="section">Giannandrea's Library</div>
      <div class="nav-group" id="libGroup">
        <div class="nav-header" role="button" aria-expanded="true">
          <div style="display:flex; align-items:center; gap:8px">
            <svg class="icon"><use href="#folder"></use></svg>
            <span>Library</span>
          </div>
          <div class="badge">1</div>
        </div>
        <div class="nav-items">
          <div class="nav-item">
            <div style="display:flex; align-items:center; gap:8px">
              <svg class="icon"><use href="#book"></use></svg>
              <span>Impact &amp; ESG</span>
            </div>
            <svg class="icon"><use href="#chev-right"></use></svg>
          </div>
        </div>
      </div>

      <button class="button ghost" style="margin-top:10px; width:100%">
        <svg class="icon"><use href="#plus"></use></svg>
        Create a new space
      </button>

      <div class="promo panel" style="border-radius:12px">
        <strong>Upgrade to HIve Pro</strong>
        <div class="muted">Unlimited savings & co‑pilot, 30 h/month YouTube transcription, Claude 3.5 Sonnet</div>
        <button class="button" style="justify-self:start">Learn more</button>
      </div>

      <div id="dbStatus" class="muted" style="font-size:12px; margin-top:8px"></div>

      <button class="button" id="bulkIndexAll" style="margin-top:8px; width:100%">Bulk Index All</button>

      <div class="meter">
        <div class="row"><span>YT transcript</span><span class="muted">0m / 2h</span></div>
        <div class="bar" data-val="15"><span></span></div>
        <div class="row"><span>Materials upload</span><span class="muted">0 / 30</span></div>
        <div class="bar" data-val="0"><span></span></div>
        <div class="row"><span>Assistant requests</span><span class="muted">0 / 50</span></div>
        <div class="bar" data-val="0"><span></span></div>
        <div class="row"><span>Research requests</span><span class="muted">0 / 0</span></div>
        <div class="bar" data-val="0"><span></span></div>
      </div>

      <div class="spacer"></div>
      <div class="section">Preferences</div>
      <div class="nav-group">
        <div class="nav-item"><div style="display:flex; align-items:center; gap:8px"><svg class="icon"><use href="#user"></use></svg> <span>My profile</span></div></div>
        <div class="nav-item"><div style="display:flex; align-items:center; gap:8px"><svg class="icon"><use href="#settings"></use></svg> <span>Settings</span></div></div>
        <div class="nav-item" id="lightMode"><div style="display:flex; align-items:center; gap:8px"><svg class="icon"><use href="#sun"></use></svg> <span>Light mode</span></div></div>
        <div class="nav-item"><div style="display:flex; align-items:center; gap:8px"><svg class="icon"><use href="#chrome"></use></svg> <span>Chrome extension</span></div></div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main panel" aria-label="Main content">
      <div class="topbar">
        <div class="search" role="search">
          <svg><use href="#search"></use></svg>
          <input placeholder="Search in space 'Giannandrea's Library'" />
        </div>
        <button class="go-btn" title="Go">
          <svg class="icon"><use href="#arrow"></use></svg>
        </button>
      </div>

      <div class="content" id="content">
        <div class="content-head">
          <div class="title">
            <h2>My Library</h2>
            <span class="muted">1 item</span>
          </div>
          <div class="view-controls">
            <button class="button ghost" title="Filter"><svg class="icon"><use href="#sliders"></use></svg></button>
            <div class="segmented" role="tablist">
              <button id="cardsBtn" class="active" role="tab">Cards</button>
              <button id="listBtn" role="tab">List</button>
            </div>
          </div>
        </div>

        <div class="card-grid" id="grid">
          <article class="lib-card" tabindex="0">
            <div class="lib-visual">
              <div style="display:grid; place-items:center; gap:8px">
                <svg class="icon" style="width:28px; height:28px"><use href="#box"></use></svg>
                <span class="muted">Cover</span>
              </div>
            </div>
            <div style="display:grid; gap:6px">
              <div style="font-weight:600">Impact &amp; ESG</div>
              <div class="lib-meta">
                <span>0 items</span>
                <span>Giannandrea G</span>
                <span title="Settings"><svg class="icon"><use href="#settings"></use></svg></span>
              </div>
            </div>
          </article>
        </div>
      </div>
    </main>

    <!-- RIGHT -->
    <aside class="right panel" aria-label="Assistant" id="chatPanel">
      <div class="stage" id="chatStage" style="padding:12px; width:100%">
        <div id="chatMessages" class="panel" style="padding:12px; border-radius:12px; border:1px solid var(--border); background:var(--panel-2); height:340px; overflow:auto"></div>
        <div id="ragDebug" class="rag-debug"></div>
      </div>
      <div class="composer panel">
        <div class="composer-head">
          <div>Ask HIve assistant</div>
          <div style="display:flex; gap:8px">
            <button class="button ghost" title="Edit"><svg class="icon"><use href="#edit"></use></svg></button>
            <button class="button ghost" title="Clear" id="clearChatBtn">Clear</button>
            <button class="button ghost" id="closeChat" title="Hide chat">Hide</button>
          </div>
        </div>
        <div class="composer-body">
          <div class="muted">context: <span id="chatScopeLabel">All Libraries</span></div>
          <div class="input">
            <svg class="icon"><use href="#spark"></use></svg>
            <input placeholder="Type your question" aria-label="Ask assistant" id="chatInput"/>
            <div class="pill" id="modelBtn" role="button" aria-haspopup="menu" aria-expanded="false">Mistral ▾</div>
            <div class="menu" id="modelMenu" role="menu" aria-label="Model selector">
              <button role="menuitem" data-model="Mistral">Mistral</button>
              <button role="menuitem" data-model="GPT-4o">GPT-4o</button>
              <button role="menuitem" data-model="Claude 3.5 Sonnet">Claude 3.5 Sonnet</button>
            </div>
          </div>
          <div style="display:flex; gap:8px; align-items:center">
            <label class="muted" style="font-size:12px">Search scope</label>
            <select id="spaceScope" style="flex:1; background:transparent; color:var(--text); border:1px solid var(--border); border-radius:8px; padding:6px 8px">
              <option value="ALL" selected>ALL</option>
            </select>
          </div>
          <div class="muted" style="font-size:12px">Tip: press <span class="kbd">Shift</span> + <span class="kbd">Enter</span> for a new line</div>
        </div>
      </div>
    </aside>
    <button class="chat-tab" id="openChat"><svg class="icon"><use href="#spark"></use></svg> Chat</button>
    <div class="scrim" id="scrim" aria-hidden="true"></div>
    <!-- App modals -->
    <div class="modal-scrim" id="modalScrim" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-head">
          <div id="modalTitle">Add item</div>
          <button class="button ghost" id="modalClose">Close</button>
        </div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-actions">
          <button class="button ghost" id="modalCancel">Cancel</button>
          <button class="button" id="modalOk">OK</button>
        </div>
      </div>
    </div>
    <div class="toasts" id="toasts"></div>
  </div>

  <!-- ICON SPRITE -->
  <svg width="0" height="0" style="position:absolute; visibility:hidden">
    <symbol id="search" viewBox="0 0 24 24"><path fill="currentColor" d="M10 2a8 8 0 1 1 5.293 13.707l4 4-1.414 1.414-4-4A8 8 0 0 1 10 2m0 2a6 6 0 1 0 0 12 6 6 0 0 0 0-12"/></symbol>
    <symbol id="arrow" viewBox="0 0 24 24"><path fill="currentColor" d="M4 11h12.586l-4.293-4.293L13 5l6 6-6 6-1.707-1.707L16.586 13H4z"/></symbol>
    <symbol id="sun" viewBox="0 0 24 24"><path fill="currentColor" d="M6.76 4.84l-1.8-1.79L3.17 4.84l1.79 1.8L6.76 4.84zm10.48 0l1.8-1.79 1.79 1.79-1.79 1.8-1.8-1.8zM12 4V1h-0v3h0zm7 8h3v0h-3v0zM4 12H1v0h3v0zm8 8v3h0v-3h0zm7.24-1.84l1.79 1.8-1.79 1.79-1.8-1.79 1.8-1.8zM6.76 18.16l-1.8 1.8-1.79-1.8 1.79-1.79 1.8 1.79zM12 7a5 5 0 1 1 0 10 5 5 0 0 1 0-10z"/></symbol>
    <symbol id="spark" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2l1.8 5.2L19 9l-5.2 1.8L12 16l-1.8-5.2L5 9l5.2-1.8L12 2zm7 11l.9 2.6L23 17l-3.1 1.4L19 21l-.9-2.6L15 17l3.1-1.4L19 13zM3 13l.9 2.6L7 17l-3.1 1.4L3 21l-.9-2.6L-1 17l3.1-1.4L3 13z"/></symbol>
    <symbol id="folder" viewBox="0 0 24 24"><path fill="currentColor" d="M10 4l2 2h6a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h4z"/></symbol>
    <symbol id="book" viewBox="0 0 24 24"><path fill="currentColor" d="M6 3h11a2 2 0 0 1 2 2v14H7a2 2 0 0 0-2 2V5a2 2 0 0 1 1-2z"/></symbol>
    <symbol id="chev-right" viewBox="0 0 24 24"><path fill="currentColor" d="M9 6l6 6-6 6-1.5-1.5L12 12 7.5 7.5z"/></symbol>
    <symbol id="plus" viewBox="0 0 24 24"><path fill="currentColor" d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></symbol>
    <symbol id="user" viewBox="0 0 24 24"><path fill="currentColor" d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-4.418 0-8 2.239-8 5v1h16v-1c0-2.761-3.582-5-8-5z"/></symbol>
    <symbol id="settings" viewBox="0 0 24 24"><path fill="currentColor" d="M12 8a4 4 0 1 1-4 4 4 4 0 0 1 4-4m8.94 4a7 7 0 0 0-.14-1l2.1-1.64-2-3.46-2.49 1a7.22 7.22 0 0 0-1.73-1l-.38-2.65h-4l-.38 2.65a7.22 7.22 0 0 0-1.73 1l-2.49-1-2 3.46L3.2 11a7 7 0 0 0 0 2l-2.1 1.64 2 3.46 2.49-1a7.22 7.22 0 0 0 1.73 1l.38 2.65h4l.38-2.65a7.22 7.22 0 0 0 1.73-1l2.49 1 2-3.46-2.1-1.64a7 7 0 0 0 .14-1Z"/></symbol>
    <symbol id="chrome" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2a10 10 0 0 1 8.66 5H12a5 5 0 0 0-4.33 2.5L4.1 4.27A10 10 0 0 1 12 2m0 20a10 10 0 0 1-8.66-5H12a5 5 0 0 0 4.33-2.5l3.57 5.23A10 10 0 0 1 12 22m0-14a4 4 0 1 1-4 4 4 4 0 0 1 4-4Z"/></symbol>
    <symbol id="sliders" viewBox="0 0 24 24"><path fill="currentColor" d="M11 3h2v10h-2V3zm-6 6h2v12H5V9zm12 4h2v8h-2v-8z"/></symbol>
    <symbol id="edit" viewBox="0 0 24 24"><path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></symbol>
    <symbol id="box" viewBox="0 0 24 24"><path fill="currentColor" d="M21 7l-9-5-9 5 9 5 9-5zm-9 7L3 9v8l9 5 9-5V9l-9 5z"/></symbol>
  </svg>

  <script type="module">
    // Supabase client via CDN (v2) with simple env discovery
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
    import { marked } from 'https://cdn.jsdelivr.net/npm/marked@12/+esm';
    // Lightweight Mistral API caller
    async function callMistral(prompt, apiKey, model='mistral-medium-latest'){
      // Call secured Supabase Edge Function to avoid CORS/key exposure
      const anon = util_getEnv('SUPABASE_ANON_KEY', 'SUPABASE_ANON_KEY');
      const resp = await fetch('https://lmrnnfjuytygomdfujhs.supabase.co/functions/v1/mistral-chat', {
        method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${anon}`, 'apikey': anon },
        body: JSON.stringify({ prompt, model })
      });
      if(!resp.ok){ const t = await resp.text(); throw new Error(t); }
      const data = await resp.json();
      return data.reply || '';
    }
    function util_getEnv(key, promptLabel){
      // Try window var → localStorage → prompt once (for quick dev)
      const winVal = window[key];
      if (winVal) return winVal;
      const lsKey = `HIve_${key}`;
      const fromLs = localStorage.getItem(lsKey);
      if (fromLs) return fromLs;
      const asked = prompt(`${promptLabel} not set. Paste it now to continue:`, '');
      if (asked) localStorage.setItem(lsKey, asked);
      return asked || '';
    }
    let supabase = null;
    function getSupabase(){
      if (supabase) return supabase;
      const url = util_getEnv('SUPABASE_URL', 'SUPABASE_URL');
      const anon = util_getEnv('SUPABASE_ANON_KEY', 'SUPABASE_ANON_KEY');
      if (!url || !anon) {
        throw new Error('Supabase URL or ANON KEY missing. Define window.SUPABASE_URL and window.SUPABASE_ANON_KEY or set once via the prompt.');
      }
      supabase = createClient(url, anon, { auth: { persistSession: true, autoRefreshToken: true } });
      return supabase;
    }
    function util_debounce(fn, wait){
      let t = null; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
    }
    // -------- File text extraction helpers --------
    async function extractPdfText(file){
      try{
        const pdfjsLib = await import('https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.mjs');
        const buf = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
        let text = '';
        for(let i=1;i<=pdf.numPages;i++){
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          text += content.items.map(it=>('str' in it? it.str: '')).join(' ') + '\n';
        }
        return text.trim();
      }catch{ return ''; }
    }
    async function extractDocxText(file){
      try{
        const JSZip = (await import('https://cdn.jsdelivr.net/npm/jszip@3.10.1/+esm')).default;
        const buf = await file.arrayBuffer();
        const zip = await JSZip.loadAsync(buf);
        const doc = zip.file('word/document.xml');
        if(!doc) return '';
        const xml = await doc.async('string');
        const text = xml.replace(/<w:p[^>]*>/g,'\n').replace(/<[^>]+>/g,'').replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>');
        return text.trim();
      }catch{ return ''; }
    }
    // Collapsible nav group
    const libGroup = document.getElementById('libGroup');
    const header = libGroup.querySelector('.nav-header');
    const items = libGroup.querySelector('.nav-items');
    header.addEventListener('click', () => {
      const open = items.style.display !== 'none';
      items.style.display = open ? 'none' : 'grid';
      header.setAttribute('aria-expanded', String(!open));
    });

    // View toggle
    const content = document.getElementById('content');
    const globalSearchInput = document.querySelector('.topbar .search input');
    let currentQuery = '';
    globalSearchInput?.addEventListener('input', () => { currentQuery = (globalSearchInput.value || '').toLowerCase(); render(); });
    const cardsBtn = document.getElementById('cardsBtn');
    const listBtn = document.getElementById('listBtn');
    function setView(mode){
      content.classList.toggle('list', mode === 'list');
      cardsBtn.classList.toggle('active', mode === 'cards');
      listBtn.classList.toggle('active', mode === 'list');
    }
    cardsBtn.addEventListener('click', () => setView('cards'));
    listBtn.addEventListener('click', () => setView('list'));

    // Theme toggle
    const root = document.documentElement;
    const toggleTheme = document.getElementById('toggleTheme');
    const lightMode = document.getElementById('lightMode');
    function flipTheme(){
      const isLight = root.getAttribute('data-theme') === 'light';
      root.setAttribute('data-theme', isLight ? 'dark' : 'light');
    }
    toggleTheme.addEventListener('click', flipTheme);
    lightMode.addEventListener('click', flipTheme);

    // ------------------- Data access (Supabase) -------------------
    async function db_listSpaces(){
      const sb = getSupabase();
      const { data, error } = await sb.from('spaces').select('*').order('created_at', { ascending: true });
      if (error) throw error;
      return data;
    }
    async function db_createSpace(name){
      const sb = getSupabase();
      const { data, error } = await sb.from('spaces').insert({ name }).select('*').single();
      if (error) throw error;
      return data;
    }
    async function db_deleteSpace(id){
      const sb = getSupabase();
      const { error } = await sb.from('spaces').delete().eq('id', id);
      if (error) throw error;
    }
    async function db_getSpace(id){
      const sb = getSupabase();
      const { data, error } = await sb.from('spaces').select('*').eq('id', id).single();
      if (error) throw error;
      return data;
    }
    async function db_updateSpace(id, fields){
      const sb = getSupabase();
      const { data, error } = await sb.from('spaces').update({ ...fields }).eq('id', id).select('*').single();
      if (error) throw error;
      return data;
    }
    async function db_listFiles(spaceId){
      const sb = getSupabase();
      const { data, error } = await sb.from('files').select('*').eq('space_id', spaceId).order('created_at', { ascending: true });
      if (error) throw error;
      return data;
    }
    async function db_listNotes(spaceId){
      const sb = getSupabase();
      const { data, error } = await sb.from('notes').select('*').eq('space_id', spaceId).order('updated_at', { ascending: false });
      if (error) throw error;
      return data;
    }
    async function db_createNote(spaceId){
      const sb = getSupabase();
      const { data, error } = await sb.from('notes').insert({ space_id: spaceId, title: 'Untitled', content: '' }).select('*').single();
      if (error) throw error;
      return data;
    }
    async function db_updateNote(id, fields){
      const sb = getSupabase();
      const { data, error } = await sb.from('notes').update({ ...fields }).eq('id', id).select('*').single();
      if (error) throw error;
      return data;
    }
    async function db_deleteNote(id){
      const sb = getSupabase();
      const { error } = await sb.from('notes').delete().eq('id', id);
      if (error) throw error;
    }
    // Simple chat history (local only)
    let chatHistory = [];
    const MISTRAL_API_KEY = 'DFIPb3EswNqtOF49sfGhTIxApmfLtDUU';
    let systemGuidelines = 'You are HIve. Use the provided context from the user\'s libraries/spaces when available. If none, answer briefly without fabricating citations. Do not preface with assurances like "Understood". If you used sources, include brief citations.';

    // ------------------- Router (hash-based) -------------------
    function getRoute(){
      const hash = location.hash.replace(/^#/, '');
      if (hash.startsWith('space/')){
        return { view: 'space', id: hash.split('/')[1] };
      }
      return { view: 'library' };
    }
    window.addEventListener('hashchange', () => render());

    // ------------------- Rendering -------------------
    const navItems = document.querySelector('#libGroup .nav-items');
    const createSpaceBtn = document.querySelector('.sidebar .button.ghost + .promo') ? null : null; // placeholder
    const newSpaceBtn = document.querySelector('.sidebar .button.ghost[style*="margin-top:10px"]');

    // Modal utilities
    const modalScrim = document.getElementById('modalScrim');
    const modalBody = document.getElementById('modalBody');
    const modalTitle = document.getElementById('modalTitle');
    const modalOk = document.getElementById('modalOk');
    const modalCancel = document.getElementById('modalCancel');
    const modalClose = document.getElementById('modalClose');
    function openModalWithExtractor(title, bodyHtml, extractor){
      modalTitle.textContent = title;
      modalBody.innerHTML = bodyHtml;
      modalScrim.classList.add('modal-show');
      modalScrim.setAttribute('aria-hidden','false');
      // focus first focusable
      setTimeout(()=>{ const first = modalBody.querySelector('input, textarea, button, select'); if(first) first.focus(); }, 0);
      function onKey(e){ if(e.key==='Escape'){ e.preventDefault(); cleanup({ ok:false }); } }
      return new Promise((resolve) => {
        function cleanup(result){
          modalScrim.classList.remove('modal-show');
          modalScrim.setAttribute('aria-hidden','true');
          modalOk.onclick = null; modalCancel.onclick = null; modalClose.onclick = null;
          document.removeEventListener('keydown', onKey);
          resolve(result);
        }
        modalOk.onclick = () => {
          try{ const values = extractor ? extractor(modalBody) : null; cleanup({ ok:true, values }); }
          catch(err){ alert(err?.message || err); }
        };
        modalCancel.onclick = () => cleanup({ ok:false });
        modalClose.onclick = () => cleanup({ ok:false });
        document.addEventListener('keydown', onKey);
      });
    }
    // Toasts
    const toastsEl = document.getElementById('toasts');
    function showToast(msg){
      const el = document.createElement('div'); el.className = 'toast'; el.textContent = msg;
      toastsEl.appendChild(el); setTimeout(()=>{ el.remove(); }, 2500);
    }

    async function render(){
      const route = getRoute();
      if (route.view === 'library'){
        await renderLibrary();
      } else if (route.view === 'space'){
        await renderSpace(route.id);
      }
    }

    async function renderLibrary(){
      // Rebuild main content header and grid scaffold
      const contentEl = document.getElementById('content');
      contentEl.innerHTML = `
        <div class="content-head">
          <div class="title">
            <h2>My Library</h2>
            <span class="muted">&nbsp;</span>
          </div>
          <div class="view-controls">
            <button class="button ghost" title="Filter"><svg class="icon"><use href="#sliders"></use></svg></button>
            <div class="segmented" role="tablist">
              <button id="cardsBtn" class="active" role="tab">Cards</button>
              <button id="listBtn" role="tab">List</button>
            </div>
          </div>
        </div>
        <div class="card-grid" id="grid"></div>`;

      // Rebind view toggle buttons
      const cardsBtn2 = contentEl.querySelector('#cardsBtn');
      const listBtn2 = contentEl.querySelector('#listBtn');
      function setViewLocal(mode){
        contentEl.classList.toggle('list', mode === 'list');
        cardsBtn2.classList.toggle('active', mode === 'cards');
        listBtn2.classList.toggle('active', mode === 'list');
      }
      cardsBtn2.addEventListener('click', () => setViewLocal('cards'));
      listBtn2.addEventListener('click', () => setViewLocal('list'));

      // Connection status check
      const statusEl = document.getElementById('dbStatus');
      try {
        const sb = getSupabase();
        const { error } = await sb.from('spaces').select('id', { count: 'exact', head: true });
        if (error) throw error;
        if (statusEl) statusEl.textContent = 'Database: Connected';
      } catch (e) {
        if (statusEl) statusEl.textContent = 'Database: Not connected - ' + (e && e.message ? e.message : e);
      }
      // Sidebar list of spaces
      let spaces = await db_listSpaces().catch(err => { console.error(err); return []; });
      if (currentQuery){ spaces = spaces.filter(s => (s.name||'').toLowerCase().includes(currentQuery)); }
      navItems.innerHTML = '';
      for (const s of spaces){
        const item = document.createElement('div');
        item.className = 'nav-item';
        item.innerHTML = `<div style="display:flex; align-items:center; gap:8px"><svg class="icon"><use href="#book"></use></svg><span>${s.name}</span></div><svg class="icon"><use href="#chev-right"></use></svg>`;
        item.addEventListener('click', () => { location.hash = `space/${s.id}`; });
        navItems.appendChild(item);
      }
      // Main grid of spaces
      const grid = contentEl.querySelector('#grid');
      grid.innerHTML = '';
      for (const s of spaces){
        const card = document.createElement('article');
        card.className = 'lib-card';
        card.tabIndex = 0;
        const cover = s.cover_url ? `<img src="${s.cover_url}" alt="cover" style="width:100%; height:160px; object-fit:cover; border-radius:12px">` : `<div style=\"display:grid; place-items:center; gap:8px\"><svg class=\"icon\" style=\"width:28px; height:28px\"><use href=\"#box\"></use></svg><span class=\"muted\">${s.name.substring(0, 20)}</span></div>`;
        card.innerHTML = `
          <div class="lib-visual" style="overflow:hidden">${cover}</div>
          <div style="display:grid; gap:6px">
            <div style="font-weight:600">${s.name}</div>
            <div class="lib-meta">
              <span>Space</span>
              <span></span>
              <span title="Delete" data-del>🗑️</span>
            </div>
          </div>`;
        card.addEventListener('click', (e) => {
          if (e.target && typeof e.target.closest === 'function' && e.target.closest('[data-del]')){ return; }
          location.hash = `space/${s.id}`;
        });
        card.querySelector('[data-del]')?.addEventListener('click', async (e) => {
          e.stopPropagation();
          if (confirm(`Delete space "${s.name}"? This cannot be undone.`)){
            await db_deleteSpace(s.id).catch(alert);
            render();
          }
        });
        grid.appendChild(card);
      }
    }

    async function renderSpace(spaceId){
      // Load space, files and notes
      let [space, files, notes] = await Promise.all([
        db_getSpace(spaceId).catch(() => ({ id: spaceId, name: 'Space' })),
        db_listFiles(spaceId).catch(() => []),
        db_listNotes(spaceId).catch(() => [])
      ]);
      if (currentQuery){
        const q = currentQuery; const has = (s) => (s||'').toLowerCase().includes(q);
        files = files.filter(f => has(f.name) || has(f.content_type) || has(f.url));
        notes = notes.filter(n => has(n.title) || has(n.content));
      }
      const contentEl = document.getElementById('content');
      contentEl.innerHTML = `
        <div class="content-head">
          <div class="title" style="display:flex; align-items:center; gap:10px">
            <img id="spaceCover" src="${space.cover_url||''}" alt="cover" style="width:32px; height:32px; border-radius:8px; object-fit:cover; border:1px solid var(--border)">
            <h2 id="spaceTitle" contenteditable="true" title="Click to rename">${space.name || 'Space'}</h2>
            <span class="muted">Files & Notes</span>
          </div>
          <div class="view-controls">
            <button class="button ghost" id="coverBtn" title="Change cover">Cover</button>
            <button class="button ghost" id="reindexBtn" title="Reindex for AI">Reindex</button>
            <button class="button ghost" id="backToLib">Back</button>
          </div>
        </div>
        <div class="card-grid" id="spacePanels" style="grid-template-columns:1fr 1fr">
          <section class="lib-card">
            <div style="font-weight:600; margin-bottom:6px">Files</div>
            <div style="display:flex; gap:8px; margin-bottom:6px">
              <button class="button" id="addLinkBtn">Add link</button>
              <button class="button" id="uploadBtn">Upload file</button>
            </div>
            <div id="filesFilters" style="display:flex; gap:8px; margin-bottom:6px">
              <input id="fileTagFilter" placeholder="Filter by tag" style="flex:1; background:transparent; border:1px solid var(--border); color:var(--text); padding:6px 8px; border-radius:8px">
            </div>
            <div id="filesList" class="lib-meta" style="display:grid; gap:8px"></div>
          </section>
          <section class="lib-card">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px">
              <div style="font-weight:600">Notes</div>
              <button class="button" id="addNoteBtn">New note</button>
            </div>
            <div style="display:flex; gap:8px; margin-bottom:6px"><input id="noteTagFilter" placeholder="Filter by tag" style="flex:1; background:transparent; border:1px solid var(--border); color:var(--text); padding:6px 8px; border-radius:8px"></div>
            <div id="notesList" style="display:grid; gap:10px"></div>
          </section>
        </div>`;

      // Editable title: save on blur or Enter
      const titleEl = contentEl.querySelector('#spaceTitle');
      titleEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); titleEl.blur(); }
      });
      titleEl.addEventListener('blur', async () => {
        const newName = (titleEl.textContent || '').trim();
        if (!newName || newName === space.name) return;
        try { await db_updateSpace(spaceId, { name: newName }); showToast('Space renamed'); }
        catch (err) { alert(err?.message || err); titleEl.textContent = space.name; return; }
        render();
      });

      // Fill files
      const filesList = contentEl.querySelector('#filesList');
      const tagFilterVal = (contentEl.querySelector('#fileTagFilter')?.value || '').toLowerCase();
      const filteredFiles = tagFilterVal ? files.filter(f => (f.tags||[]).some(t => (t||'').toLowerCase().includes(tagFilterVal))) : files;
      filesList.innerHTML = filteredFiles.map(f => {
        const href = f.url || (f.storage_path ? `https://lmrnnfjuytygomdfujhs.supabase.co/storage/v1/object/public/hive-attachments/${f.storage_path}` : '#');
        const preview = (f.content_type||'').startsWith('image/') ? `<img src="${href}" alt="${f.name}" style="max-height:40px; border-radius:6px">` : `<svg class="icon"><use href="#box"></use></svg>`;
        const tags = (f.tags||[]).map(t=>`<span class=\"pill\" data-del-file-tag=\"${f.id}::${t}\">${t} ✕</span>`).join(' ');
        return `<div style="display:flex; align-items:center; justify-content:space-between; border:1px solid var(--border); padding:8px; border-radius:10px"><div style="display:flex; align-items:center; gap:10px"><a href="${href}" target="_blank">${preview}</a><a href="${href}" target="_blank">${f.name}</a></div><div style="display:flex; gap:10px; align-items:center"><span class="muted">${f.content_type || ''}</span>${tags}<button class="button ghost" data-add-file-tag="${f.id}">Add tag</button><button class="button ghost" data-del-file="${f.id}">Delete</button></div></div>`;
      }).join('');
      filesList.querySelectorAll('[data-del-file]').forEach((btn) => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const id = btn.getAttribute('data-del-file');
          const sb = getSupabase();
          const { error } = await sb.from('files').delete().eq('id', id);
          if (error) { console.error('Delete file error', error); showToast('Delete failed'); }
          else { showToast('File deleted'); render(); }
        });
      });
      filesList.querySelectorAll('[data-add-file-tag]').forEach((btn)=>{
        btn.addEventListener('click', async ()=>{
          const fileId = btn.getAttribute('data-add-file-tag');
          const file = files.find(ff=>ff.id===fileId);
          if(!file) return;
          const res = await openModalWithExtractor('Add file tag', `<div class=\"field\"><label>Tag</label><input id=\"tag\" placeholder=\"e.g. image\"></div>`, (root)=>({ tag:(root.querySelector('#tag')?.value||'').trim() }));
          if(!res.ok) return; const tag = res.values?.tag; if(!tag) return;
          const next = [...(file.tags||[]), tag];
          const sb = getSupabase();
          const { error } = await sb.from('files').update({ tags: next }).eq('id', fileId);
          if(error){ showToast('Failed to add tag'); } else { showToast('Tag added'); render(); }
        });
      });
      filesList.querySelectorAll('[data-del-file-tag]').forEach((chip)=>{
        chip.addEventListener('click', async ()=>{
          const payload = chip.getAttribute('data-del-file-tag');
          const [fileId, tag] = payload.split('::');
          const file = files.find(ff=>ff.id===fileId);
          if(!file) return;
          const next = (file.tags||[]).filter(t=>t!==tag);
          const sb = getSupabase();
          const { error } = await sb.from('files').update({ tags: next }).eq('id', fileId);
          if(error){ showToast('Failed to remove tag'); } else { showToast('Tag removed'); render(); }
        });
      });

      // Filter inputs change rerenders
      contentEl.querySelector('#fileTagFilter')?.addEventListener('input', util_debounce(()=>render(), 200));
      contentEl.querySelector('#noteTagFilter')?.addEventListener('input', util_debounce(()=>render(), 200));

      // Fill notes
      const notesList = contentEl.querySelector('#notesList');
      const noteTagFilterVal = (contentEl.querySelector('#noteTagFilter')?.value || '').toLowerCase();
      const filteredNotes = noteTagFilterVal ? notes.filter(nn => (nn.tags||[]).some(t => (t||'').toLowerCase().includes(noteTagFilterVal))) : notes;
      for (const n of filteredNotes){
        const row = document.createElement('div');
        row.style.border = '1px solid var(--border)';
        row.style.borderRadius = '10px';
        row.style.padding = '8px';
        row.innerHTML = `
          <input data-title placeholder="Title" value="${n.title || ''}" style="width:100%; background:transparent; border:1px solid var(--border); border-radius:8px; padding:6px; margin-bottom:6px; color:var(--text)">
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
            <textarea data-content placeholder="Write in Markdown..." style="width:100%; min-height:160px; background:transparent; border:1px solid var(--border); border-radius:8px; padding:8px; color:var(--text)">${n.content || ''}</textarea>
            <div data-preview style="border:1px solid var(--border); border-radius:8px; padding:10px; background:var(--panel)"></div>
          </div>
          <div style="display:flex; justify-content:space-between; gap:8px; margin-top:6px; align-items:center">
            <div style="display:flex; gap:6px" data-tags></div>
            <button class="button ghost" data-delete>Delete</button>
          </div>`;
        const titleEl = row.querySelector('[data-title]');
        const contentEl = row.querySelector('[data-content]');
        const previewEl = row.querySelector('[data-preview]');
        const tagsWrap = row.querySelector('[data-tags]');
        function renderTags(){
          tagsWrap.innerHTML = (n.tags||[]).map(t=>`<span class="pill">${t}</span>`).join('') + ` <button class="button ghost" data-add-tag>Add tag</button>`;
          tagsWrap.querySelector('[data-add-tag]').addEventListener('click', async()=>{
            const res = await openModalWithExtractor('Add tag', `<div class=\"field\"><label>Tag</label><input id=\"tag\" placeholder=\"e.g. research\"></div>`, (root)=>({ tag: (root.querySelector('#tag')?.value||'').trim() }));
            if (!res.ok) return; const tag = res.values?.tag; if (!tag) return;
            const next = [...(n.tags||[]), tag]; n.tags = next; renderTags(); await db_updateNote(n.id, { tags: next }).catch(console.error);
          });
        }
        renderTags();
        const renderPreview = () => { previewEl.innerHTML = marked.parse(contentEl && 'value' in contentEl ? contentEl.value : ''); };
        renderPreview();
        const autosave = util_debounce(async () => {
          const title = titleEl && 'value' in titleEl ? titleEl.value : '';
          const content = contentEl && 'value' in contentEl ? contentEl.value : '';
          await db_updateNote(n.id, { title, content, updated_at: new Date().toISOString() }).catch(console.error);
          // Background index for RAG
          try {
            await fetch('https://lmrnnfjuytygomdfujhs.supabase.co/functions/v1/rag-embed-index', {
              method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${util_getEnv('SUPABASE_ANON_KEY','SUPABASE_ANON_KEY')}`, 'apikey': util_getEnv('SUPABASE_ANON_KEY','SUPABASE_ANON_KEY') },
              body: JSON.stringify({ space_id: spaceId, items:[{ source_type:'note', source_id:n.id, content }] })
            });
          } catch {}
        }, 800);
        titleEl.addEventListener('input', autosave);
        contentEl.addEventListener('input', () => { renderPreview(); autosave(); });
        row.querySelector('[data-delete]').addEventListener('click', async () => {
          if (confirm('Delete this note?')){ await db_deleteNote(n.id).catch(alert); render(); }
        });
        notesList.appendChild(row);
      }

      // Handlers
      contentEl.querySelector('#backToLib').addEventListener('click', () => { location.hash = ''; });
      contentEl.querySelector('#addNoteBtn').addEventListener('click', async () => {
        await db_createNote(spaceId).catch(alert); showToast('Note created'); render();
      });
      contentEl.querySelector('#addLinkBtn').addEventListener('click', async () => {
        const res = await openModalWithExtractor('Add link', `
          <div class="field"><label>Name</label><input id="fName" placeholder="Link name"></div>
          <div class="field"><label>URL</label><input id="fUrl" placeholder="https://..."></div>`, (root)=>{
            const nameEl = root.querySelector('#fName');
            const urlEl = root.querySelector('#fUrl');
            return { name: nameEl && nameEl.value ? nameEl.value.trim() : '', url: urlEl && urlEl.value ? urlEl.value.trim() : '' };
          });
        if (!res.ok) { modalScrim.classList.remove('modal-show'); modalScrim.setAttribute('aria-hidden','true'); return; }
        let { name, url } = res.values || {};
        if (!name || !url) { alert('Name and URL are required'); return; }
        if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
        const sb = getSupabase();
        const { data, error } = await sb.from('files').insert([{ space_id: spaceId, name, kind: 'link', url, content_type: 'link' }]).select('*');
        if (error) { console.error('Insert link error', error); showToast('Failed to add link'); }
        else {
          try {
            await fetch('https://lmrnnfjuytygomdfujhs.supabase.co/functions/v1/rag-embed-index', {
              method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${util_getEnv('SUPABASE_ANON_KEY','SUPABASE_ANON_KEY')}`, 'apikey': util_getEnv('SUPABASE_ANON_KEY','SUPABASE_ANON_KEY') },
              body: JSON.stringify({ space_id: spaceId, items:[{ source_type:'file', source_id:data?.[0]?.id, content: `${name} ${url}` }] })
            });
          } catch {}
          showToast('Link added'); render();
        }
      });
      contentEl.querySelector('#uploadBtn').addEventListener('click', async () => {
        const res = await openModalWithExtractor('Upload file', `
          <div class="field"><label>File</label><input id="fInput" type="file"></div>
          <div class="muted" style="font-size:12px">Uploads go to public bucket 'hive-attachments'</div>`, (root)=>{
            const input = root.querySelector('#fInput');
            return { file: input && input.files && input.files[0] ? input.files[0] : null };
          });
        if (!res.ok) { modalScrim.classList.remove('modal-show'); modalScrim.setAttribute('aria-hidden','true'); return; }
        const file = res.values?.file;
        if (!file) return;
        const sb = getSupabase();
        const path = `${spaceId}/${Date.now()}_${file.name}`;
        const bucket = sb.storage.from('hive-attachments');
        const up = await bucket.upload(path, file, { upsert: true });
        if (up.error){ showToast('Upload failed'); return; }
        const pub = bucket.getPublicUrl(path).data.publicUrl;
        const { data: fRow, error: dbErr } = await sb.from('files').insert({ space_id: spaceId, name: file.name, kind: 'upload', url: pub, content_type: file.type || 'file', storage_path: path }).select('*').single();
        if (dbErr) { showToast('Failed to save file'); }
        else {
          // Index content if text, else name+url
          try {
            let textContent = '';
            if ((file.type||'').startsWith('text/')){ textContent = await file.text(); }
            else if ((file.type||'').includes('pdf')){ textContent = await extractPdfText(file); }
            else if ((file.name||'').toLowerCase().endsWith('.docx')){ textContent = await extractDocxText(file); }
            // Always include the public URL and name so search can match
            const content = `${file.name} ${pub}\n` + (textContent || `(${file.type||'file'})`);
            await fetch('https://lmrnnfjuytygomdfujhs.supabase.co/functions/v1/rag-embed-index', {
              method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${util_getEnv('SUPABASE_ANON_KEY','SUPABASE_ANON_KEY')}`, 'apikey': util_getEnv('SUPABASE_ANON_KEY','SUPABASE_ANON_KEY') },
              body: JSON.stringify({ space_id: spaceId, items:[{ source_type:'file', source_id: fRow.id, content }] })
            });
          } catch {}
          showToast('File uploaded'); render();
        }
      });
      // Reindex all notes in this space (quick pass)
      contentEl.querySelector('#reindexBtn').addEventListener('click', async ()=>{
        try{
          const notesPayload = (notes||[]).slice(0,50).map(n=>({ source_type:'note', source_id:n.id, content: `${n.title||''}\n${n.content||''}` }));
          await fetch('https://lmrnnfjuytygomdfujhs.supabase.co/functions/v1/rag-embed-index', {
            method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${util_getEnv('SUPABASE_ANON_KEY','SUPABASE_ANON_KEY')}`, 'apikey': util_getEnv('SUPABASE_ANON_KEY','SUPABASE_ANON_KEY') },
            body: JSON.stringify({ space_id: spaceId, items: notesPayload })
          });
          showToast('Reindex started');
        }catch{ showToast('Reindex failed'); }
      });

      // Change cover
      contentEl.querySelector('#coverBtn').addEventListener('click', async ()=>{
        const res = await openModalWithExtractor('Change cover', `<div class="field"><label>Upload</label><input id="coverInput" type="file" accept="image/*"></div>`, (root)=>({ file: root.querySelector('#coverInput')?.files?.[0]||null }));
        if(!res.ok) return; const file = res.values?.file; if(!file) return;
        const sb = getSupabase();
        const path = `${spaceId}/${Date.now()}_${file.name}`;
        const bucket = sb.storage.from('space-covers');
        const up = await bucket.upload(path, file, { upsert:true });
        if(up.error){ showToast('Cover upload failed'); return; }
        const url = bucket.getPublicUrl(path).data.publicUrl;
        await sb.from('spaces').update({ cover_url:url }).eq('id', spaceId);
        showToast('Cover updated'); render();
      });
    }

    // Create space button in sidebar
    const createNewSpaceBtn = document.querySelector('.sidebar .button.ghost + .promo') ? null : null; // not used
    const createSpaceSidebarBtn = document.querySelector('.sidebar .button.ghost[style*="margin-top:10px"]');
    if (createSpaceSidebarBtn){
      createSpaceSidebarBtn.addEventListener('click', async () => {
        const res = await openModalWithExtractor('Create space', `
          <div class="field"><label>Name</label><input id="spaceName" placeholder="My space"></div>`, (root)=>{
            const n = root.querySelector('#spaceName');
            return { name: n && n.value ? n.value.trim() : '' };
          });
        if (!res.ok) return;
        const name = res.values?.name;
        if (!name) { alert('Please enter a name'); return; }
        await db_createSpace(name).catch(alert);
        render();
      });
    }

    // Initial render and bulk-index button
    render().catch(console.error);
    document.getElementById('bulkIndexAll')?.addEventListener('click', async ()=>{
      try{
        const sb = getSupabase();
        const spaces = await db_listSpaces().catch(()=>[]);
        const startedAt = performance.now();
        let totalItems = 0;
        for (const sp of spaces){
          const [files, notes] = await Promise.all([
            db_listFiles(sp.id).catch(()=>[]),
            db_listNotes(sp.id).catch(()=>[])
          ]);
          const items = [];
          for (const n of notes){ items.push({ source_type:'note', source_id:n.id, content:n.content||'' }); }
          for (const f of files){ items.push({ source_type:'file', source_id:f.id, content: `${f.name} ${f.url||''}` }); }
          if (items.length){
            totalItems += items.length;
            const anon = util_getEnv('SUPABASE_ANON_KEY','SUPABASE_ANON_KEY');
            await fetch('https://lmrnnfjuytygomdfujhs.supabase.co/functions/v1/rag-embed-index', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${anon}`, 'apikey': anon }, body: JSON.stringify({ space_id: sp.id, items }) });
          }
        }
        const elapsed = Math.round(performance.now() - startedAt);
        showToast(`Bulk index submitted (${totalItems} items)`);
        console.log('RAG DEBUG: bulk-index', { totalItems, elapsedMs: elapsed });
      }catch(e){ showToast('Bulk index failed'); }
    });

    // Populate chat scope selector
    (async ()=>{
      const scopeSel = document.getElementById('spaceScope');
      if(!scopeSel) return;
      const spaces = await db_listSpaces().catch(()=>[]);
      for (const sp of spaces){
        const opt = document.createElement('option'); opt.value = sp.id; opt.textContent = sp.name; scopeSel.appendChild(opt);
      }
    })();

    // Chat open/close via side tab and scrim
    const appRoot = document.getElementById('appRoot');
    const openChat = document.getElementById('openChat');
    const closeChat = document.getElementById('closeChat');
    const scrim = document.getElementById('scrim');
    function showChat(){
      appRoot.classList.remove('chat-closed');
      appRoot.classList.add('chat-open');
    }
    function hideChat(){
      appRoot.classList.remove('chat-open');
      appRoot.classList.add('chat-closed');
    }
    openChat.addEventListener('click', showChat);
    closeChat.addEventListener('click', hideChat);
    scrim.addEventListener('click', hideChat);
    document.getElementById('askHiveBtn')?.addEventListener('click', async () => {
      showChat();
      setTimeout(()=>{ document.getElementById('chatInput')?.focus(); }, 0);
    });

    // Model dropdown
    const modelBtn = document.getElementById('modelBtn');
    const modelMenu = document.getElementById('modelMenu');
    function toggleMenu(state){
      const willOpen = state ?? !modelMenu.classList.contains('open');
      modelMenu.classList.toggle('open', willOpen);
      modelBtn.setAttribute('aria-expanded', String(willOpen));
    }
    modelBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleMenu();
    });
    modelMenu.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-model]');
      if(!btn) return;
      modelBtn.textContent = btn.dataset.model + ' ▾';
      toggleMenu(false);
    });
    document.addEventListener('click', (e) => {
      if(!modelMenu.contains(e.target) && e.target !== modelBtn){
        toggleMenu(false);
      }
    });
    // Track chosen model
    let currentModel = 'Mistral';
    modelMenu.addEventListener('click', (e) => {
      const b = e.target.closest('button[data-model]'); if(!b) return;
      currentModel = b.dataset.model;
      modelBtn.textContent = currentModel + ' ▾';
      toggleMenu(false);
    });
    // Prevent clicks inside the chat from closing it when scrim is visible
    const chatPanel = document.getElementById('chatPanel');
    chatPanel.addEventListener('click', (e) => {
      e.stopPropagation();
    });

    // ------------------- Simple chat logic + debug -------------------
    const chatMessagesEl = document.getElementById('chatMessages');
    const ragDebugEl = document.getElementById('ragDebug');
    const chatInput = document.getElementById('chatInput');
    const clearChatBtn = document.getElementById('clearChatBtn');
    function renderMessages(){
      if (!chatHistory.length){
        chatMessagesEl.innerHTML = `<div class="empty">No messages yet. Type below to start the conversation.</div>`;
        return;
      }
      chatMessagesEl.innerHTML = chatHistory.map(m => {
        if(m.role==='assistant' && m.citations){
          const cites = m.citations.map(c=>`<li><span class="muted">${(c.similarity??0).toFixed(2)}</span> ${c.content.substring(0,160)}...</li>`).join('');
          return `<div class="message assistant">${m.content}<div style="margin-top:8px"><div class="muted" style="font-size:12px">Sources</div><ul style="margin:6px 0 0 18px; padding:0">${cites}</ul></div></div>`;
        }
        return `<div class="message ${m.role}">${m.content}</div>`;
      }).join('');
      chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }

    clearChatBtn?.addEventListener('click', ()=>{ chatHistory = []; renderMessages(); });

    chatInput?.addEventListener('keydown', async (e) => {
      if (e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        const text = chatInput.value.trim();
        if (!text) return;
        const msgs = chatHistory.concat([{ role:'user', content:text }]);
        chatInput.value = '';
        chatHistory = msgs;
        renderMessages();
        // Retrieve top snippets then call model and append assistant message
        try{
          // retrieve
          const anon = util_getEnv('SUPABASE_ANON_KEY','SUPABASE_ANON_KEY');
          const scopeSel = document.getElementById('spaceScope');
          const scopeVal = scopeSel ? scopeSel.value : 'ALL';
          const searchUrl = (currentModel==='GPT-4o') ? 'https://lmrnnfjuytygomdfujhs.supabase.co/functions/v1/rag-search-openai' : 'https://lmrnnfjuytygomdfujhs.supabase.co/functions/v1/rag-search';
          const r = await fetch(searchUrl, { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${anon}`, 'apikey': anon }, body: JSON.stringify({ query: text, top_k: 6, space_id: scopeVal==='ALL'? null : scopeVal }) });
          const j = await r.json();
          const dbgHeader = `Search via: ${searchUrl.split('/').pop()} | matches: ${Array.isArray(j.matches)? j.matches.length : 0}`;
          if (ragDebugEl){ ragDebugEl.style.display='block'; ragDebugEl.textContent = dbgHeader + "\n" + JSON.stringify(j, null, 2); }
          console.log('RAG DEBUG', { searchUrl, response: j });
          // Dedup and keep top matches only
          const seen = new Set();
          const raw = Array.isArray(j.matches)? j.matches: [];
          const top = raw.filter(m=>{ const k = `${m.source_type}:${m.source_id}`; if(seen.has(k)) return false; seen.add(k); return true; }).slice(0,6);
          console.log('RAG DEBUG: matches', { count: raw.length, unique: top.length });
          const context = top.map(m=>`[${(m.similarity??0).toFixed(2)}] ${m.content}`).join('\n');
          const finalPrompt = context ? `${systemGuidelines}\n\nContext:\n${context}\n\nQuestion: ${text}` : `${systemGuidelines}\n\nQuestion: ${text}`;
          let reply = '';
          if (currentModel === 'Mistral'){
            reply = await callMistral(finalPrompt, MISTRAL_API_KEY);
          } else if (currentModel === 'GPT-4o'){
            const rr = await fetch('https://lmrnnfjuytygomdfujhs.supabase.co/functions/v1/openai-chat', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${anon}`, 'apikey': anon }, body: JSON.stringify({ prompt: finalPrompt, model:'gpt-4o-mini' }) });
            const jd = await rr.json(); reply = jd.reply || '';
          } else { reply = 'Model ' + currentModel + ' not configured.'; }
          // Only attach citations if we actually have any
          const msg = { role:'assistant', content: reply };
          if (top.length) { msg.citations = top; }
          chatHistory = chatHistory.concat([msg]);
          renderMessages();
        }catch(err){
          chatHistory = chatHistory.concat([{ role:'assistant', content: 'Error contacting model.' }]);
          renderMessages();
        }
      }
    });
    renderMessages();
    chatInput?.focus();
  </script>
</body>
</html>
